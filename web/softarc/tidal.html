<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIDAL - Beosound 5c</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="splash.css">
    <link rel="stylesheet" href="../assets/phosphor/phosphor.css">
</head>
<body>
    <div id="app">
        <div class="counter">
            <span id="current-item">1</span> / <span id="total-items">100</span>
        </div>
        <div class="hierarchy-depth-1" id="hierarchy-background"></div>
        <div class="arc-container" id="arc-container"></div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/arc-utils.js"></script>
    <script src="../js/emulator-bridge.js"></script>
    <script src="../assets/qrcode.min.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const TIDAL_URL = getServiceUrl('tidalServiceUrl', 8777);

            // Check TIDAL service state
            try {
                const resp = await fetch(`${TIDAL_URL}/playlists`);
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.setup_needed) {
                        showSetupScreen(TIDAL_URL);
                        return;
                    }
                    if (data.needs_reauth) {
                        showSetupScreen(TIDAL_URL, true);
                        return;
                    }
                    if (data.loading) {
                        showLoadingScreen();
                        return;
                    }
                    if (Array.isArray(data) && data.length === 0) {
                        showEmptyScreen();
                        return;
                    }
                }
            } catch (e) {
                // Service unavailable — fall through to local JSON
            }

            // Normal playlist browsing — load from API
            initArcList(TIDAL_URL + '/playlists');
        });

        function showSetupScreen(serviceUrl, isReconnect) {
            const title = isReconnect ? 'RECONNECT TIDAL' : 'CONNECT TIDAL';
            const msg = isReconnect
                ? 'Your session has expired.<br>Press GO to start a new login'
                : 'Press GO to start the TIDAL login process';
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="splash-screen">
                    <div class="splash-card">
                        <h2>${title}</h2>
                        <p>${msg}</p>
                        <div id="setup-qr" class="setup-qr" style="display:none"></div>
                        <div id="setup-url" class="setup-url"></div>
                        <div id="setup-status" style="color:#666;font-size:13px;margin-top:12px"></div>
                    </div>
                </div>`;

            let loginStarted = false;

            // Listen for GO button from iframe messenger
            window.addEventListener('message', async (e) => {
                if (e.data && e.data.type === 'button' && e.data.button === 'go' && !loginStarted) {
                    loginStarted = true;
                    await startLogin(serviceUrl);
                }
            });

            // Also auto-start the login
            startLogin(serviceUrl);
        }

        async function startLogin(serviceUrl) {
            const statusEl = document.getElementById('setup-status');
            const urlEl = document.getElementById('setup-url');
            const qrEl = document.getElementById('setup-qr');

            statusEl.textContent = 'Starting login...';

            try {
                const resp = await fetch(`${serviceUrl}/start-login`, { method: 'POST' });
                const data = await resp.json();
                if (data.error) {
                    statusEl.textContent = 'Error: ' + data.error;
                    return;
                }

                const url = data.url;
                urlEl.textContent = url;

                // Show QR code
                if (typeof QRCode !== 'undefined') {
                    qrEl.style.display = 'inline-block';
                    qrEl.innerHTML = '';
                    new QRCode(qrEl, {
                        text: url,
                        width: 180,
                        height: 180,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }

                statusEl.textContent = 'Scan QR code or open URL on your phone';

                // Poll for completion
                const pollInterval = setInterval(async () => {
                    try {
                        const check = await fetch(`${serviceUrl}/check-login`, { method: 'POST' });
                        const result = await check.json();
                        if (result.status === 'ok') {
                            clearInterval(pollInterval);
                            statusEl.textContent = 'Connected! Loading playlists...';
                            // Wait for playlists then reload
                            pollForPlaylists();
                        } else if (result.status === 'expired') {
                            clearInterval(pollInterval);
                            statusEl.textContent = 'Login expired. Press GO to try again.';
                            qrEl.style.display = 'none';
                            urlEl.textContent = '';
                        }
                    } catch (e) { /* keep polling */ }
                }, 3000);
            } catch (e) {
                statusEl.textContent = 'Error: ' + e.message;
            }
        }

        function showEmptyScreen() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="splash-screen">
                    <div class="splash-card">
                        <h2>NO PLAYLISTS</h2>
                        <p>Your TIDAL library has no playlists.<br>
                        Create a playlist in the TIDAL app, then come back here.</p>
                    </div>
                </div>`;

            pollForPlaylists();
        }

        function showLoadingScreen() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="splash-screen">
                    <div class="splash-card">
                        <div class="loading-spinner"></div>
                        <h2>LOADING PLAYLISTS</h2>
                        <p>Fetching your TIDAL library...</p>
                    </div>
                </div>`;

            pollForPlaylists();
        }

        function pollForPlaylists() {
            const TIDAL_URL = getServiceUrl('tidalServiceUrl', 8777);
            const poll = setInterval(async () => {
                try {
                    const resp = await fetch(`${TIDAL_URL}/playlists`);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data.loading && !document.querySelector('.loading-spinner')) {
                            clearInterval(poll);
                            showLoadingScreen();
                            return;
                        }
                        if (Array.isArray(data) && data.length > 0) {
                            clearInterval(poll);
                            location.reload();
                        }
                    }
                } catch (e) { /* keep polling */ }
            }, 3000);
        }

        function initArcList(dataUrl) {
            const tidalConfig = {
                dataSource: dataUrl || '../json/tidal_playlists.json',
                dataType: 'parent_child',
                viewMode: 'hierarchical',
                parentKey: 'tracks',
                parentNameKey: 'name',
                storagePrefix: 'tidal_arclist',
                title: 'TIDAL',
                context: 'tidal',
                sourceCommandUrl: getServiceUrl('tidalServiceUrl', 8777) + '/command',
                childNameMapper: (track, index, allTracks) => {
                    const allSameArtist = allTracks && allTracks.every(t => t.artist === allTracks[0].artist);
                    let displayName;
                    if (allSameArtist) {
                        displayName = track.name;
                    } else {
                        displayName = `${track.name}\n(${track.artist})`;
                    }
                    return {
                        id: track.id,
                        name: displayName,
                        image: track.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMzMzMzMzIi8+Cjx0ZXh0IHg9IjMyIiB5PSI0MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjI0IiBmaWxsPSIjZmZmZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7imqo8L3RleHQ+Cjwvc3ZnPgo='
                    };
                }
            };

            const arcList = new ArcList(tidalConfig);
            window.arcListInstance = arcList;
        }
    </script>
</body>
</html>
