<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BeoSound 5 Dashboard</title>
  <style>
    /* Fixed viewport */
    html, body { margin:0; padding:0; width:1024px; height:768px; overflow:hidden; }
    #main-ui {
      position: relative;
      width: 1024px;
      height: 768px;
      background: black;
      display: flex;
    }
    /* Navigation column */
    #nav {
      width: 8%;        /* ~82px */
      min-width: 80px;
      background: #1c1c1c;
      color: white;
      font-family: sans-serif;
      padding-top: 20px;
      position: relative;
    }
    #nav ul { list-style: none; margin:0; padding:0; }
    #nav li {
      padding: 12px;
      cursor: default;
    }
    #nav li.active {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    #laser-pointer {
      position: absolute;
      width: 4px; height: 24px;
      background: cyan;
      left: 0;
      transition: top 0.1s;
    }
    /* Artwork area */
    #artwork-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    #artwork {
      position: absolute;
      max-width: 90%;
      max-height: 90%;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      border-radius: 8px;
      transition: opacity 0.6s ease;
    }
    #info-box {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      font-family: sans-serif;
      text-align: center;
      z-index: 2;
    }
    #info-box #track-title { font-size: 24px; margin-bottom:4px; }
    #info-box #track-album { font-size: 16px; margin-bottom:2px; }
    #info-box #track-artist { font-size: 14px; opacity:0.9; }
    /* WebSocket log */
    #ws-log {
      position: absolute;
      top: 0; right: 0;
      background: red;
      color: white;
      font-family: monospace;
      font-size: 0.8em;
      padding: 4px;
      width: 300px;
      height: 60px;
      overflow: hidden;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="main-ui">
    <nav id="nav">
      <div id="laser-pointer"></div>
      <ul>
        <li>Playing now</li>
        <li>Playlists</li>
        <li>Security</li>
        <li>Control</li>
        <li>Settings</li>
      </ul>
    </nav>
    <div id="artwork-container">
      <img id="artwork" src="" alt="Art" />
      <div id="info-box">
        <div id="track-title">—</div>
        <div id="track-album">—</div>
        <div id="track-artist">—</div>
      </div>
      <div id="ws-log"></div>
    </div>
  </div>

  <script>
    // Element refs
    const navItems = [...document.querySelectorAll('#nav li')];
    const pointer  = document.getElementById('laser-pointer');
    const artwork  = document.getElementById('artwork');
    const trackTitle  = document.getElementById('track-title');
    const trackAlbum  = document.getElementById('track-album');
    const trackArtist = document.getElementById('track-artist');
    const wsLog       = document.getElementById('ws-log');

    // HA config
    const HA_URL   = 'http://homeassistant.local:8123';
    const HA_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjMDY0NDFjNDRjOWM0YTQ3ODk1OWVmMjcwYzY2MTU2ZiIsImlhdCI6MTc0NTI2ODYzNywiZXhwIjoyMDYwNjI4NjM3fQ.ldZPYpESQgL_dQj026faUhBzqTgJBVH4oYSrXtWzfC0';
    const ENTITY  = 'media_player.medierum';

    // WebSocket
    const WS_URL = 'ws://localhost:8765';
    const ws = new WebSocket(WS_URL);
    const recent = [];
    function logMsg(m) {
      recent.unshift(m);
      if(recent.length>3) recent.pop();
      wsLog.innerText = recent.join('\n');
    }
    ws.onopen  = ()=> logMsg('WS open');
    ws.onclose = ()=> logMsg('WS close');
    ws.onerror = e => logMsg('WS error');
    ws.onmessage = ev => {
      const {type,data} = JSON.parse(ev.data);
      logMsg(`${type}: ${JSON.stringify(data)}`);
      switch(type) {
        case 'button':
          // navigate menu
          const idx = data.button==='left'   ? getActiveIndex()+1
                     : data.button==='right'  ? getActiveIndex()-1
                     : getActiveIndex();
          activateItem(idx);
          break;
        case 'laser':
          // map 0-100 to items
          const pos = Math.round(data.position / 100 * (navItems.length-1));
          activateItem(pos);
          break;
        case 'playback':
          fetchMedia();
          break;
      }
    };

    function getActiveIndex() {
      return navItems.findIndex(li=>li.classList.contains('active'));
    }
    function activateItem(i) {
      if(i<0) i=0;
      if(i>=navItems.length) i=navItems.length-1;
      navItems.forEach((li,j)=> li.classList.toggle('active', j===i));
      const navRect = document.getElementById('nav').getBoundingClientRect();
      const itmRect = navItems[i].getBoundingClientRect();
      pointer.style.top = (itmRect.top - navRect.top + 4) + 'px';
    }

    // initial activate & fetch
    activateItem(0);
    fetchMedia();
    setInterval(fetchMedia, 5000);

    // fetch media from HA
    async function fetchMedia() {
      try{
        const res = await fetch(`${HA_URL}/api/states/${ENTITY}`, {
          headers:{'Authorization':'Bearer '+HA_TOKEN}
        });
        const d = await res.json();
        const pic = HA_URL + d.attributes.entity_picture;
        trackTitle.textContent  = d.attributes.media_title      || '—';
        trackAlbum.textContent  = d.attributes.media_album_name || '—';
        trackArtist.textContent = d.attributes.media_artist     || '—';
        // load & crossfade
        if(artwork.src !== pic) {
          artwork.style.opacity = 0;
          artwork.addEventListener('transitionend', function once() {
            artwork.removeEventListener('transitionend', once);
            artwork.src = pic;
            artwork.style.opacity = 1;
          });
        }
      } catch(e){ console.warn(e); }
    }
  </script>
</body>
</html>

