<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Test</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        
        #camera-iframe {
            width: 100%;
            height: 75vh;
            border: none;
        }
        
        .selected-card {
            border: 4px solid yellow !important;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.7) !important;
            outline: 2px solid orange !important;
        }
        
        #status {
            padding: 10px;
            background: #333;
            color: white;
            font-family: monospace;
        }
        
        #controls {
            padding: 10px;
            background: #222;
            color: white;
        }
        
        button {
            margin: 5px;
            padding: 8px 12px;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <iframe id="camera-iframe" src="http://homeassistant.local:8123/dashboard-cameras/home" allow="fullscreen"></iframe>
    <div id="status">Navigation: Q = Next Camera, W = Previous Camera | Current: 0/0</div>
    <div id="controls">
        <button id="refresh-cards">Refresh Camera Cards</button>
        <button id="prev-card">Previous Camera (W)</button>
        <button id="next-card">Next Camera (Q)</button>
        <span id="debug-info"></span>
    </div>
    
    <script>
        // Global variables
        let currentIndex = -1;
        let cameraCards = [];
        const statusElement = document.getElementById('status');
        const debugElement = document.getElementById('debug-info');
        const iframe = document.getElementById('camera-iframe');
        let iframeDoc = null;
        let retryCount = 0;
        const MAX_RETRIES = 5;
        
        // Function to select a card by index
        function selectCard(index) {
            if (!cameraCards.length) return;
            
            // Remove selection from all cards
            cameraCards.forEach(card => {
                try {
                    card.style.border = "";
                    card.style.boxShadow = "";
                    card.style.outline = "";
                    card.classList.remove('selected-card');
                } catch (e) {
                    console.error("Error removing styles:", e);
                }
            });
            
            // Add selection to current card
            if (index >= 0 && index < cameraCards.length) {
                try {
                    const card = cameraCards[index];
                    card.classList.add('selected-card');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    statusElement.textContent = `Navigation: Q = Next Camera, W = Previous Camera | Current: ${index + 1}/${cameraCards.length}`;
                } catch (e) {
                    console.error("Error applying styles:", e);
                }
            }
        }
        
        // Navigate to next card
        function nextCard() {
            if (cameraCards.length === 0) {
                findCameraCards(); // Try to find cards if none exist
                return;
            }
            currentIndex = (currentIndex + 1) % cameraCards.length;
            selectCard(currentIndex);
        }
        
        // Navigate to previous card
        function prevCard() {
            if (cameraCards.length === 0) {
                findCameraCards(); // Try to find cards if none exist
                return;
            }
            currentIndex = (currentIndex - 1 + cameraCards.length) % cameraCards.length;
            selectCard(currentIndex);
        }
        
        // Try different selectors to find camera cards
        function findCameraCardsWithSelectors() {
            if (!iframeDoc) return [];
            
            // Try multiple selectors that might match camera cards
            const selectors = [
                'ha-card',
                '.card-content',
                '.ha-camera-card',
                'hui-camera-card',
                'hui-card',
                '.ha-card',
                'div[class*="camera"]',
                'div.card'
            ];
            
            let cards = [];
            for (const selector of selectors) {
                try {
                    const found = Array.from(iframeDoc.querySelectorAll(selector));
                    if (found.length > 0) {
                        debugElement.textContent = `Found ${found.length} cards with selector: ${selector}`;
                        cards = found;
                        break;
                    }
                } catch (e) {
                    console.error(`Error with selector ${selector}:`, e);
                }
            }
            
            return cards;
        }
        
        // Function to find all camera cards in the iframe
        function findCameraCards() {
            try {
                // Try to get iframe document
                iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // Check if we can access the document
                if (!iframeDoc || !iframeDoc.body) {
                    retryCount++;
                    if (retryCount <= MAX_RETRIES) {
                        statusElement.textContent = `Waiting for iframe content... (attempt ${retryCount}/${MAX_RETRIES})`;
                        setTimeout(findCameraCards, 1000);
                    } else {
                        statusElement.textContent = "Error: Could not access iframe content after multiple attempts.";
                    }
                    return;
                }
                
                // Wait longer for Home Assistant to render fully
                setTimeout(() => {
                    // Try to find cards with various selectors
                    cameraCards = findCameraCardsWithSelectors();
                    
                    if (cameraCards.length > 0) {
                        statusElement.textContent = `Navigation: Q = Next Camera, W = Previous Camera | Current: ${currentIndex + 1}/${cameraCards.length}`;
                        
                        // Select first card if we have cards
                        if (currentIndex === -1) {
                            currentIndex = 0;
                            selectCard(currentIndex);
                        }
                    } else {
                        statusElement.textContent = "No camera cards found. Try clicking 'Refresh Camera Cards'.";
                        
                        // Try again with a longer timeout
                        if (retryCount <= MAX_RETRIES) {
                            retryCount++;
                            setTimeout(findCameraCards, 2000);
                        }
                    }
                }, 3000); // Increased timeout to 3 seconds
            } catch (error) {
                console.error("Error finding camera cards:", error);
                statusElement.textContent = "Error: Could not access iframe content. CORS issue?";
            }
        }
        
        // Set up event listeners
        document.addEventListener('keydown', function(event) {
            if (event.key.toLowerCase() === 'q') {
                nextCard();
            } else if (event.key.toLowerCase() === 'w') {
                prevCard();
            }
        });
        
        // Button event listeners
        document.getElementById('refresh-cards').addEventListener('click', function() {
            retryCount = 0;
            statusElement.textContent = "Refreshing camera cards...";
            findCameraCards();
        });
        
        document.getElementById('prev-card').addEventListener('click', prevCard);
        document.getElementById('next-card').addEventListener('click', nextCard);
        
        // Wait for iframe to load
        iframe.addEventListener('load', function() {
            try {
                iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // Try to add keyboard event listener to the iframe
                try {
                    iframeDoc.addEventListener('keydown', function(event) {
                        if (event.key.toLowerCase() === 'q') {
                            nextCard();
                        } else if (event.key.toLowerCase() === 'w') {
                            prevCard();
                        }
                    });
                } catch (error) {
                    console.error("Could not add event listener to iframe:", error);
                }
                
                // Find camera cards when loaded
                findCameraCards();
                
                // Set up a mutation observer to detect when new cards are added
                try {
                    const observer = new MutationObserver(() => {
                        const newCards = findCameraCardsWithSelectors();
                        if (newCards.length !== cameraCards.length) {
                            cameraCards = newCards;
                            statusElement.textContent = `Navigation: Q = Next Camera, W = Previous Camera | Current: ${currentIndex + 1}/${cameraCards.length}`;
                            if (currentIndex >= 0 && currentIndex < cameraCards.length) {
                                selectCard(currentIndex);
                            } else if (cameraCards.length > 0) {
                                currentIndex = 0;
                                selectCard(currentIndex);
                            }
                        }
                    });
                    
                    // Start observing the iframe document body
                    observer.observe(iframeDoc.body, { 
                        childList: true, 
                        subtree: true,
                        attributes: true
                    });
                } catch (error) {
                    console.error("Could not set up mutation observer:", error);
                }
            } catch (error) {
                console.error("Error accessing iframe document:", error);
                statusElement.textContent = "Error: Could not access iframe content. CORS issue?";
            }
        });
        
        // Initial attempt to find camera cards
        setTimeout(findCameraCards, 1000);
    </script>
</body>
</html>
